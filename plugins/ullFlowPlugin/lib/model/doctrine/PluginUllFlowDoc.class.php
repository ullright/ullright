<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
abstract class PluginUllFlowDoc extends BaseUllFlowDoc
{

  protected
    $memoryComment = ''
  ;
  
  /**
   * add Doctrine_Filter to handle virtual columns transparently
   *
   */
  public function setUp()
  {
    parent::setUp();
    
    $this->unshiftFilter(new UllFlowDocRecordFilter());
  }

  /**
   * pre save hook
   * 
   * always makes the UllFlowDoc record dirty (=modified)
   * this is necessary, because often only the virtual columns change, but not
   * the own columns change.
   *
   * @param unknown_type $event
   */
  public function preSave($event)
  {
    $this->dirty = $this->dirty == 1 ? 2 : 1;
  }
  
  /**
   * pre insert record hook
   * 
   * set defaults
   *
   * @param unknown_type $event
   */
  public function preInsert($event)
  {
    $this->setDefaults();
  }
  
  /**
   * pre update record hook
   *
   * @param unknown_type $event
   */  
  public function preUpdate($event)
  {
    $this->setDefaults();    
  }    
  
  /**
   * post insert record hook
   * 
   * automatically create a UllFlowMemory
   *
   * @param unknown_type $event
   */
  public function postInsert($event)
  {
//    sfContext::getInstance()->getLogger()->err('postinsert: ' . $this->title);
    $this->createMemory(); 
    
  }
  
  /**
   * post update record hook
   *
   * @param unknown_type $event
   */  
  public function postUpdate($event)
  {
//    sfContext::getInstance()->getLogger()->err('postupdate: ' . $this->title);
    $this->createMemory();    
  }    

  /**
   * transparently set the UllFlowMemory comment
   *
   * @param string $value
   */
  public function setMemoryComment($value)
  {
    $this->memoryComment = $value;
  }
  
  /**
   * Set the value of a virtual column
   *
   * @param string $ullFlowColumnConfigSlug
   * @param string $value
   * @return mixed
   */
  public function setValueByColumn($ullFlowColumnConfigSlug, $value)
  {
    $ullFlowValue = UllFlowValueTable::findByDocIdAndSlug($this->id, $ullFlowColumnConfigSlug);
    $ullFlowValue->value = $value;
    return $ullFlowValue->save();
  }  
  
  /**
   * Get the value of a virtual column
   *
   * @param string $ullFlowColumnConfigSlug
   * @return mixed
   */
  public function getValueByColumn($ullFlowColumnConfigSlug)
  {
    $ullFlowValue = UllFlowValueTable::findByDocIdAndSlug($this->id, $ullFlowColumnConfigSlug);
    return $ullFlowValue->value;
  }
  
  /**
   * Returns an array with the values of the virtual columns
   * 
   * Example: 
   * array(
   *   'my_title' => 'This is my title',
   *   'my_email' => 'darth.vader@ull.at',
   * );
   * 
   * @return array
   */
  public function getVirtualValuesAsArray()
  {
    $values = $this->UllFlowValues;
    
    $return = array();
    
    foreach ($values as $value)
    {
      $return[$value->UllFlowColumnConfig->slug] = $value->value;
    }
    
    return $return;
  }
  
  /**
   * Returns an array containing the virtual columns
   * 
   * Example: 
   * array(
   *   'my_title',
   *   'my_email', 
   * );
   * 
   * @return array
   */
  public function getVirtualColumnsAsArray()
  {
    $columns = $this->UllFlowApp->UllFlowColumnConfigs;

    $return = array();
    
    foreach ($columns as $column)
    {
      $return[] = $column->slug;
    }
    
    return $return;
  }  
  
  /**
   * get the ull_user_id of the currently logged in user, or '1' for the Master Admin user otherwhise
   *
   * @return int ull_user_id
   */
  protected function getUser()
  {
    // check for symfony context (none for example for doctrine:data-load)
    if (sfContext::hasInstance())
    {
      return sfContext::getInstance()->getUser()->getAttribute('user_id', 1);
    }
    else
    {
      return 1;
    }
  }
  
  /**
   * Set Defaults
   *
   */
  protected function setDefaults()
  {
    if (!$this->ull_flow_action_id)
    {
      $this->ull_flow_action_id = Doctrine::getTable('UllFlowAction')->findBySlug('save_only')->getFirst()->id;
    }
    
    if (!$this->assigned_to_ull_entity_id)
    {
      $this->assigned_to_ull_entity_id = $this->getUser(); 
    }

    if (!$this->assigned_to_ull_flow_step_id)
    {
      $this->assigned_to_ull_flow_step_id = $this->UllFlowApp->getStartStep();
    }

    // create memory
//    $this->UllFlowMemories[0]->ull_flow_step_id = $this->assigned_to_ull_flow_step_id;
//    $this->UllFlowMemories[0]->ull_flow_action_id = $this->ull_flow_action_id;
//    $this->UllFlowMemories[0]->assigned_to_ull_entity_id = $this->assigned_to_ull_entity_id;
//    //TODO: has to be the previous assigned_to_ull_entity_id
//    $this->UllFlowMemories[0]->creator_ull_entity_id = $this->getUser();
//    $this->UllFlowMemories[0]->comment = $this->memoryComment;    
    
  }
  
  /**
   * create UllFlowMemory entry
   *
   */
  protected function createMemory()
  {
    $memory = new UllFlowMemory;
    $memory->ull_flow_doc_id = $this->id;
    $memory->ull_flow_step_id = $this->assigned_to_ull_flow_step_id;
    $memory->ull_flow_action_id = $this->ull_flow_action_id;
    $memory->assigned_to_ull_entity_id = $this->assigned_to_ull_entity_id;
    //TODO: has to be the previous assigned_to_ull_entity_id
    $memory->creator_ull_entity_id = $this->getUser();
    $memory->comment = $this->memoryComment;
    $memory->save();
  }
  
}