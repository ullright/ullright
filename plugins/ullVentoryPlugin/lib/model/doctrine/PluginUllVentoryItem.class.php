<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
abstract class PluginUllVentoryItem extends BaseUllVentoryItem
{
  
  public function findMemoriesOrderedByDate()
  {
    $q = new Doctrine_Query;
    $q
      ->from('UllVentoryItemMemory x')
      ->addWhere('x.ull_ventory_item_id = ?', $this->id)
      //additional ordering by id is a hack to properly order in case of exactly the same date 
      ->orderBy('x.transfer_at DESC, x.updated_at DESC, x.id DESC')  
    ;      
     
    return $q->execute();    
  }
  
  /**
   * Toggle inventory taking
   * 
   * Creates or removes an entry in UllVentoryItemTaking for the current (=latest)
   * UllVentoryTaking
   *  
   * @return none
   */
  public function toggleInventoryTaking()
  {
    $taking = UllVentoryTakingTable::findLatest();
    
    if ($taking)
    {
      $itemTaking = UllVentoryItemTakingTable::findByItemAndTaking($this, $taking);
    
      if ($itemTaking)
      {
        $itemTaking->delete();
        $this->refresh(true);
        $this->UllVentoryItemMemory[] = $this->createMemory('Inventory taking withdrawn: ' . $taking->name);
      }
      else
      {
        $this->UllVentoryItemTaking[]->UllVentoryTaking = UllVentoryTakingTable::findLatest();
        $this->UllVentoryItemTaking->save();
        $this->UllVentoryItemMemory[] = $this->createMemory('Inventory taking: ' . $taking->name);
      }
      $this->UllVentoryItemMemory->save();
    }
  }
  
  public function hasLatestInventoryTaking()
  {
    $taking = UllVentoryTakingTable::findLatest();
    
    if (($taking !== false) && UllVentoryItemTakingTable::findByItemAndTaking($this, $taking))
    {
      return true;
    }
    return false;
  }

  /**
   * Create a new UllVentoryItemMemory for the current item
   * 
   * @param $comment string
   * @param $transfer_at string
   * @param $source_ull_entity_id integer
   * @param $target_ull_entity_id integer
   * @return UllVentoryItemMemory
   */
  public function createMemory($comment, $transfer_at = null, $source_ull_entity_id = null, $target_ull_entity_id = null)
  {
    $memory = new UllVentoryItemMemory;
    $memory->transfer_at = ($transfer_at) ? $transfer_at : date('Y-m-d');
    $memory->source_ull_entity_id = ($source_ull_entity_id) ? $source_ull_entity_id : $this->ull_entity_id;
    $memory->target_ull_entity_id = ($target_ull_entity_id) ? $target_ull_entity_id : $this->ull_entity_id;
    $memory->comment = $comment;
    
    return $memory;
  }

}