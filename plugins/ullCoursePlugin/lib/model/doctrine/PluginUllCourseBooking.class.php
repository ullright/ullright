<?php

/**
 * PluginUllCourseBooking
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
abstract class PluginUllCourseBooking extends BaseUllCourseBooking
{
  
  public function postInsert($event)
  {
    $this->sendConfirmationMail();
  }
  
  /**
   * pre save hook
   */
  public function preSave($event)
  {
    // Fixes fixture loading. At the moment of loading UllCourseBookings
    // UllCourseTariffCourse is not loaded yet.
    if (Doctrine::getTable('UllCourseTariffCourse')->count())
    {
      UllCourseBookingTable::validateTarif($this);
    }
  }

  /**
   * post save hook
   * 
   * @param unknown_type $event
   */
  public function postSave($event)
  {
    $this->UllCourse->updateProxies();    
  }
  
  /**
   * Send booking confirmation and payment information 
   */
  public function sendConfirmationMail()
  {
    // We cannot send emails without an email address
    if (!$this->UllUser->email)
    {
      return;
    }
    
    $mail = new ullsfMail('ull_course_booked');
    
    $mail->setFrom(
      sfConfig::get('app_ull_course_from_address'),
      sfConfig::get('app_ull_course_from_name')
    );
    $mail->addAddress($this->UllUser);

    $mail->usePartial('ullCourse/bookedMail', array(
      'booking' => $this
    ));
    
    $mail->send();
  }  
  
}